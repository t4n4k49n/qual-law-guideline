name: normalized-promotion-completion

on:
  push:
    branches: [main]
    paths:
      - "runs/**/RUN.md"
      - "data/normalized/**"

jobs:
  verify-promotion-completion:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verify promotion commits recorded in RUN.md
        shell: bash
        run: |
          set -euo pipefail

          BEFORE="${{ github.event.before }}"
          AFTER="${{ github.sha }}"

          CHANGED="$(git diff --name-only "$BEFORE" "$AFTER")"
          echo "changed files:"
          echo "$CHANGED"

          RUN_FILES="$(echo "$CHANGED" | grep -E '^runs/.+/RUN\.md$' || true)"
          if [[ -z "$RUN_FILES" ]]; then
            echo "no RUN.md changes, skip."
            exit 0
          fi

          FAILED=0
          while IFS= read -r RUN_FILE; do
            [[ -z "$RUN_FILE" ]] && continue

            if ! grep -q '昇格実施結果' "$RUN_FILE"; then
              echo "skip (no promotion record): $RUN_FILE"
              continue
            fi

            PROMOTION_COMMIT="$(grep -Eo 'promotion_commit:[[:space:]]*`?[0-9a-f]{7,40}`?' "$RUN_FILE" | head -n1 | grep -Eo '[0-9a-f]{7,40}' || true)"
            if [[ -z "$PROMOTION_COMMIT" ]]; then
              echo "ERROR: promotion_commit is missing in $RUN_FILE"
              FAILED=1
              continue
            fi

            echo "verify $RUN_FILE -> $PROMOTION_COMMIT"
            if ! python3 scripts/check_normalized_promotion_completion.py --promotion-commit "$PROMOTION_COMMIT" --main-ref origin/main; then
              FAILED=1
            fi
          done <<< "$RUN_FILES"

          if [[ "$FAILED" -ne 0 ]]; then
            echo "normalized promotion completion check failed."
            exit 1
          fi

          echo "normalized promotion completion check passed."

