# 正規化 yaml ４ファイルの解説

## 1. 正規化とは？

以下の目的を達成するために、法令・ガイドラインを**共通フォーマットに整える**こと。

- 医薬・製薬の関連法令およびガイドライン（以降、法令等と呼ぶ）への適合性を担保するため、DQの法令等適合性チェックにて活用する。
- 具体的にはDQ書類のGMPチェックシートとして実装される。
- 同チェックシートの生成に際して、法令等の条文等をチェック項目として表示する。
- ユーザーはプロジェクトごとに最適なチェック項目を選択し、実際にそのチェックを行うことで、上記の狙いを達成する。


この目的を実現するため、①法令等の条文をチェック項目として**最適な単位に分割**している。また、②チェック項目の補足説明として、その**チェック項目（条文）より上位の情報も表示可能**としている。例えば「第10条第2項」だけを見せても意味が通じない場合は、親（第10条）や先祖（見出し）を必要に応じて“呼び出せる”構造となっており、設定により簡単にカスタマイズできる。

---

正規化の実行例（国内e-Gov法令の場合）

```bash
xml2ir bundle --input <path-to-xml> --out-dir out/<run_id> --doc-id <doc_id> --emit-only all
```

上記コマンドを実行すると、`out/<run_id>/` に **同一の `doc_id` を軸にした4つのYAML** が出力されます。

- `jp_egov_336M50000100002_20260501_507M60000100117.meta.yaml`
- `jp_egov_336M50000100002_20260501_507M60000100117.parser_profile.yaml`
- `jp_egov_336M50000100002_20260501_507M60000100117.regdoc_ir.yaml`
- `jp_egov_336M50000100002_20260501_507M60000100117.regdoc_profile.yaml`


---

## 2. ４ファイルで１セット

4ファイルはそれぞれ役割が違い、**分業しているからこそ運用しやすい**構成です。

- `regdoc_ir`：本文（中身）を「最小単位で」構造化した本体
- `parser_profile`：本文をどう読んで構造化するか（読み取りルール）
- `regdoc_profile`：用途別にどう見せるか／どう選ばせるか（表示・選択ルール）
- `meta`：それらを束ね、「これは何の文書を、いつ、何から、どう生成したか」を保証する台帳

イメージ図（概念）:

```mermaid
flowchart LR
  A[入力XML] --> B[xml2ir bundle]
  B --> M[meta.yaml
(台帳・生成履歴)]
  B --> P[parser_profile.yaml
(読み取りルール)]
  B --> I[regdoc_ir.yaml
(本文IR: 構造化コンテンツ)]
  B --> R[regdoc_profile.yaml
(用途別: 選択/表示ルール)]
  M --> I
  M --> P
  M --> R
  I --> U[UI/チェックシート生成/検索]
  R --> U
  M --> U
```

---

## 3. ４ファイル概要

| ファイル | ひとことで | 主な利用者 | 役割 |
|---|---|---|---|
| `*.meta.yaml` | **レビュー・監査対応用台帳** | PM/QA/監査/開発 | 出所・版・生成条件等を追跡可能 |
| `*.parser_profile.yaml` | **構造化ルール（章/条/項/号/イロハ等の判定規則）** | 開発/データ整備 | 国・文書ごとに異なる構造（番号体系等）の可視化 |
| `*.regdoc_ir.yaml` | **本文の中間表現（IR）＝正規化データ本体** | 開発/プロダクト | 選択・表示・検索・ソート可能な法令等構造化データ |
| `*.regdoc_profile.yaml` | **親・先祖情報の補足表示設定** | PM/プロダクト/開発 | 表示する親・先祖を用途別に設定可能 |

---

## 4. 各ファイルの詳細

### 4.1 `jp_egov_<law_id>_<as_of>_<revision_id>.meta.yaml`（台帳・生成履歴）

**何が入っている？**
- 文書の身元: `doc.id`, `title`, `jurisdiction`, `doc_type`, `language`
- e-Govの識別子: `identifiers.e_gov_law_id`, `identifiers.e_gov_revision_id`
- 版情報（いつの版か）: `version.as_of`
- 取得元URLと取得日時: `sources[].url`, `sources[].retrieved_at`
- 「同梱物」: `bundle.ir.path`, `bundle.parser_profile.path`, `bundle.regdoc_profile.path`
- 生成条件: `generation.created_at`, `generation.tool.name`, `generation.inputs[].path`, `generation.inputs[].checksum`

**何のため？（目的とのつながり）**
- 「この正規化データは、どの法令の、いつの版を、どこから取ってきたものか」を保証します。
- PRレビューや監査での説明責任（出所・時点・改ざん耐性）を担います。
- `bundle` があるため、**metaを見れば“必要なファイルが揃っているか”がわかる**構造になっています。

**PM/監査目線でのチェックポイント（例）**
- `doc.id` がPRで扱っている対象URLと一致しているか
- `version.as_of` が想定版か（例：改正日）
- `sources.url` が一次ソース（e-Gov等）になっているか
- `generation.inputs[].checksum` が入っているか（入力同一性の担保）

> 補足: PLAYBOOKには `out/<run_id>/manifest.yaml` の作成もあります。  
> `manifest.yaml` はRUN（作業単位）全体の記録で、`*.meta.yaml` は**文書（doc_id）単体の台帳**です。役割が違うので両方あると強いです。

---

### 4.2 `jp_egov_<law_id>_<as_of>_<revision_id>.parser_profile.yaml`（読み取りルール）

**何が入っている？**
- `marker_types`: 「第◯条」「一」「ロ」「(1)」などを、どの種類（章/条/項…）として認識するかのパターン
- `structure`: 「章の下に条が来る」「条の下に項/号/イロハが来る」など、許される親子関係
- `compound_prefix`: 深い階層（例：CFRの(a)(1)(i)のような連鎖）を扱うための補助設定

**何のため？（目的とのつながり）**
- 国・文書系列ごとに **番号体系（行頭記号）が違う**ため、ここを“設定”として分離しておくと拡張が楽です。
- 例えば日本法の「項・号・イロハ」や、CFRの「(a)(1)(i)」等を同じ仕組みで扱えます。
- ルールがYAMLで明示されているので、**ブラックボックス化せずレビュー可能**です（「なぜこの段落が“項”扱いなのか」を説明できる）。

**変更すると何が起きる？**
- `parser_profile` が変わると、構造の切れ方（どこが項でどこが号か）が変わる可能性があり、結果として `regdoc_ir` が変わり得ます。  
  → 基本は **再RUN（再生成）対象**です。

---

### 4.3 `jp_egov_<law_id>_<as_of>_<revision_id>.regdoc_ir.yaml`（本文IR：正規化の本体）

**何が入っている？**
- `content`: 文書を木構造（章→節→条→項→号→イロハ…）として表した本体
- 各ノード（章・条・号など）の共通フィールド例:
  - `nid`: ノードID（例：`art12.i2.ro`）
  - `kind`: 種別（chapter/article/item/subitem…）
  - `num`: 表示上の番号（例：`第十二条`、`二`、`ロ`）
  - `heading`: 見出し（例：`（一般区分の…）`）
  - `text`: 本文（要件文）
  - `ord`: 並び順（比較・検証用）
  - `role` / `normativity`: 「構造」か「要件（must等）」かの区別（チェックシート用途で重要）
- `index.display_name_by_nid`: `nid` → 人間表示名（TOC/ラベル）への引き当て（UIや検索に便利）

**“最小単位化”の具体例（このファイルが価値を出すところ）**

例として、以下の条文は `nid=art12.i2.ro` のように一意に表せます。

- 条：第十二条（見出し：一般区分…）
- 号：二（作業所は…）
- イロハ：ロ（常時居住する場所及び…）

つまり「どの条文を選んだか」を **nidで確定**でき、UI・検索・差分比較・チェックシート生成の全てで同じキーを使えます。

**レビューで重要なこと**
- `nid` が一意で、階層が正しい（親子関係が破綻していない）
- `ord` が単調増加など、機械的に比較できる並びになっている  
  （PLAYBOOKの `check_ord_format_and_order` 等はこの品質を担保する狙い）

---

### 4.4 `jp_egov_<law_id>_<as_of>_<revision_id>.regdoc_profile.yaml`（用途別の見せ方・選ばせ方）

**何が入っている？**
`profiles` の下に、用途別の「選択・表示ポリシー」が入ります。例では `dq_gmp_checklist` という用途プロファイルが定義されています。

主な要素:
- `selectable_kinds`: UIで「選択肢」として提示する粒度（例：subitem/item/paragraph…）
- `grouping_policy`: 選択肢をどの単位でまとめるか（例：subitemはitemの下でまとめる）
- `context_display_policy`: 選んだ条文を表示する際に、どこまで先祖（文脈）を含めるか  
  例：`include_ancestors_until_kind: article`（条まで遡る）、`include_headings: true`（見出しを出す）

**何のため？（目的とのつながり）**
- 「ロだけだと意味が通じないので、条見出しや上位の説明も出したい」  
  「でも兄弟（ロの次のハ）を選ぶときは毎回同じ文脈を出したくない」  
  …といった **GMPチェックシートの“見せ方の慣習”**を、データ側に宣言的に持てます。
- これにより、本文IR（`regdoc_ir`）は共通のまま、用途（DQ/監査/教育等）に応じて表示や選択粒度だけを差し替えられます。

**変更すると何が起きる？**
- `regdoc_profile` の変更は、基本的に「UIの見せ方・選ばせ方」の変更です。  
  目的が「表示ルールの調整」なら、`regdoc_ir` を変えずにここだけ更新できる設計です。

---

## 5. 本来目的と4ファイルの位置付け

本来の目的に照らして4ファイルの位置付けを整理すると、以下の通り。

### 目的A：GMPチェックシートに必要な単位へ細分化
- 主役: **`regdoc_ir.yaml`**
- 補助: `parser_profile.yaml`（正しく細分化するためのルール）

### 目的B：単体表示を補う親・先祖の表示
- 主役: **`regdoc_profile.yaml`**（どこまで先祖を出すかの設定）
- 前提: `regdoc_ir.yaml`（親子関係が保持されていること）

### 目的C：国内外・複数フォーマット（XML/TXT等）横断の正規化
- 主役: **`parser_profile.yaml` + `regdoc_ir.yaml`**
- 補助: `meta.yaml`（文書の種類・出所を揃えて管理するため）

### 目的D：「いつ、何を、どう作ったか」の履歴（Git運用対応）
- 主役: **`meta.yaml`**
- 補助: `regdoc_ir.yaml`（比較表やレビュー素材の本体）

---

## 6. 実務での変更や調整

| 変更/調整 | 例 | 対象ファイル | 再生成要否 |
|---|---|---:|---|
| 表示の調整（文脈の出し方、選択粒度） | 「ロは条見出しまで表示」</br>「号は条だけで良い」 |`regdoc_profile` | 原則不要 | 
| 構造の読み取り誤り（号とイロハが崩れる等） | 「(i) を subitem と誤認」 | `parser_profile` | ほぼ必要 |
| 入力文書の版が変わった | 法令改正/条文変更 | `meta`+`regdoc_ir`</br>（一式） | 必要 |
| ツールの仕様変更でIRが変わる | バージョン更新など | `schema` 全体 | 推奨 |

---

## 7. 初見者のための”とっつき”

1) **まずmeta.yamlを見る**  
「対象文書は何か」「いつの版か」「ソースはどこか」が分かれば、レビューの前提が揃います。

2) **regdoc_ir.yamlでサンプル条文を1つ探す**  
例：`第十二条` や `ロ` のように分かりやすい箇所が、ちゃんと `nid` 付きで構造化されているか。

3) **regdoc_profile.yamlで“見せ方”の方針を見る**  
選択粒度（どこまで細かく選ばせるか）と、文脈（どこまで先祖を出すか）が目的に合っているか。

---

## 8. 用語ミニ辞典

- **doc_id**: 文書を一意に指すID。e-GovのURL（law_id / as_of / revision_id）に準拠させると運用が安定します。
- **IR（中間表現）**: 入力形式（XML/TXT等）に依存しない共通の構造化データ。
- **nid**: 文書内ノードID。UIの選択肢や差分比較のキーになる。
- **kind**: ノードの種類（chapter/article/paragraph/item/subitem…）。
- **ord**: 並び順。機械的な検証・差分比較のための安定キー。
- **profile**: 「読み方（parser）」や「見せ方（regdoc）」など、共通IRの周辺ルールを宣言的に持つ設定。

---

## 参考

- `NORMALIZED_RUN_PLAYBOOK.md`：RUNの運用（out→昇格、検証、PRの流れ）
- 「YAML構造提案」「YAML構造設定の質問」：GMPチェックシート用途で必要な粒度・表示文脈の要件
- 「法令ガイドラインのスキーマ設計」：文書系列ごとに異なる行頭記号スキーマ（parser_profile）と、用途別profileの考え方

